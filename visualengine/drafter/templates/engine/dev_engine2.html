<script>
	var camera, scene, renderer, controls;
	var envSun, water, sphere;
	var WORLD_ROOT = 80.0;

	var controlsEnabled = false;
	var moveForward = false;
	var moveBackward = false;
	var moveLeft = false;
	var moveRight = false;
	var moveUp = false;
	var moveDown = false;
	var canJump = false;

	var clock = new THREE.Clock();
	var prevTime = performance.now();
	var velocity = new THREE.Vector3();
	var direction = new THREE.Vector3();

	// dom elements
	var blocker = document.getElementById('blocker');
	var instructions = document.getElementById('instructions');
	var rendererTarget = document.getElementById('webgltarget');
	rendererTarget.width=window.innerWidth;


	// Cursor Locking
	var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;
	if (havePointerLock) {
		var element = document.body;
		var pointerlockchange = function (event) {
			if (document.pointerLockElement === element || document.mozPointerLockElement === element || document.webkitPointerLockElement === element) {
				controlsEnabled = true;
				controls.enabled = true;
				blocker.style.display = 'none';
			} else {
				controls.enabled = false;
				blocker.style.display = 'block';
				instructions.style.display = '';
			}
		};

		var pointerlockerror = function (event) {
			instructions.style.display = '';
		};

		// Hook pointer lock state change events
		document.addEventListener('pointerlockchange', pointerlockchange, false);
		document.addEventListener('mozpointerlockchange', pointerlockchange, false);
		document.addEventListener('webkitpointerlockchange', pointerlockchange, false);
		document.addEventListener('pointerlockerror', pointerlockerror, false);
		document.addEventListener('mozpointerlockerror', pointerlockerror, false);
		document.addEventListener('webkitpointerlockerror', pointerlockerror, false);
		instructions.addEventListener('click', function (event) {
			instructions.style.display = 'none';
			// Ask the browser to lock the pointer
			element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;
			element.requestPointerLock();
		}, false);

	} else {
		instructions.innerHTML = 'Your browser doesn\'t seem to support Pointer Lock API';
	}


	init();
	animate();

	function init() {
		// params
		var sunPosParams = {
			distance: 400,
			inclination: -0.1749,
			azimuth: 0.214
		};

		var sceneParams = {
			sceneFogColor: 0xF2F5F8,
			sceneFogDensity: 0.0001,
			sceneSkyLightColor: 0x404040,
			sceneSkyLightIntensity: 1
		};

		var rendererParams = {
			antialias: true,
			enableShadowMap: true,
		};

		var skyParams = {};
		var sunParams = {
			enableShadows: true,
		};
		var waterParams = {
			alpha: 1.0,
			distortionScale: 3.7,
			size: .1
		};

		var userCameraParams = {
			fov: 40,
			pos: [650, 250, -900],
			rot: [0, -180, 0]
		};

		var defaultGeometry = {
			landmass: 'landmass.obj',
			named: 'nyc_named.obj',
			blocks: 'test_blocks.obj',
			parks: 'nyc_parks.obj'
		};

		var heroGeometry = {
			ery: 'hy_ery.obj',
			hy: 'hy_hy.obj'
		};

		var materialParams = {
			defaultHero: {
				color: 0x6AD4EB,
				roughness: 0,
				metalness: 0.2,
				flatShading: true
			},
			defaultContext: {
				color: 0xE2E2E2,
				roughness: .1,
				metalness: .2,
				flatShading: true
			},
			defaultLandMass: {
				color: 0xc7c7c7,
				roughness: .9,
				metalness: 0,
				flatShading: true
			},
		};

		// regular used container sizes with aspect.
		// visualcontainers.exampleRes = [width, height, aspect]
		//
		//visualContainers = {
		//	fullScreen = [window.innerWidth, window.innerHeight, window.innerWidth / window.innerHeight],
		//	mapPage = [width.innerWidth, 500, window.innerWidth / window.innerHeight]
		//};

		// default Environment
		renderer = buildDefaultRenderer(document, rendererTarget, rendererParams)
		keyBindings(document)

		scene = buildDefaultScene(sceneParams);
		sky = buildDefaultSky(scene)
		envSun = buildSun(scene, sunParams);
		var waterGeometry = buildDefaultWater(scene, envSun, waterParams);

		var cubeCamera = new THREE.CubeCamera(1, 20000, 256);
		cubeCamera.renderTarget.texture.minFilter = THREE.LinearMipMapLinearFilter;

		updateSun(scene, renderer, cubeCamera, envSun, sky, water, sunPosParams);

		camera = new THREE.PerspectiveCamera(userCameraParams.fov, rendererTarget.offsetWidth / rendererTarget.offsetHeight, 1, 20000);
		controls = new THREE.PointerLockControls(camera, userCameraParams);
		scene.add(controls.getObject());

		parseGeometryParams(defaultGeometry, m_context, scene, WORLD_ROOT, envmap=cubeCamera.renderTarget.texture);
		parseGeometryParams(heroGeometry, m_hy, scene, WORLD_ROOT, envmap=cubeCamera.renderTarget.texture);

				window.addEventListener( 'resize', onWindowResize, false );
	}

	function onWindowResize() {
		camera.aspect = window.innerWidth / rendererTarget.offsetHeight;
		camera.updateProjectionMatrix();
		renderer.setSize( window.innerWidth, rendererTarget.offsetHeight );
	}

	function animate() {
		requestAnimationFrame(animate);
		water.material.uniforms.time.value += 1.0 / 60.0;

		if (controlsEnabled === true) {
			var time = performance.now();
			var delta = (time - prevTime) / 1000;

			velocity.x -= velocity.x * 5.0 * delta;
			velocity.z -= velocity.z * 5.0 * delta;
			velocity.y -= velocity.y * 5.0 * delta;
			//velocity.y -= 9.8 * 1 * delta; // 100.0 = mass
			direction.z = Number(moveForward) - Number(moveBackward);
			direction.x = Number(moveLeft) - Number(moveRight);
			direction.y = Number(moveUp) - Number(moveDown);
			direction.normalize(); // this ensures consistent movements in all directions

			if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
			if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;
			if (moveUp || moveDown) velocity.y -= direction.y * 400.0 * delta;

			controls.getObject().translateX(velocity.x * delta);
			controls.getObject().translateY(velocity.y * delta);
			controls.getObject().translateZ(velocity.z * delta);

			prevTime = time;
		}

		renderer.render(scene, camera);
	}
</script>